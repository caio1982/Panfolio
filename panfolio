#!/usr/bin/env python
# -*- coding: utf-8 -*-

__license__   = 'All original files are public domain'
__author__    = 'Caio Begotti'
__email__     = 'caio1982@gmail.com'
__credits__   = ['']

"""
Panfolio is a tiny Python script to generate a nice
simple gallery of all your vacations photos
"""

import os
import sys
import mimetypes
import argparse
import glob
import shutil

import Image as image

parser = argparse.ArgumentParser()
parser.add_argument('-d', '--dir', help='your photos directory')
parser.add_argument('-f', '--fullscreen', help='makes a full screen pictures-only gallery', action='store_true')
args = parser.parse_args()

def main():
    resources = ['default.css',
                 'jquery-1.7.1.min.js',
                 'jquery.masonry.min.js']
    size = 256, 256
    allimages = args.dir + '/*'
    outpath = args.dir + '.panfolio'
    if not os.path.exists(outpath):
        os.makedirs(outpath)
    else:
        print 'Thumbnails directory %s not empty, creation skipped' % outpath

    html_header = """
<html>
<head>
	<!-- should be dynamic via a command line option to set it -->
	<title>Panfolio, a nice simple gallery of all your pictures</title>

	<!-- gotta document which version of masonry works best -->
	<script src=".panfolio/jquery-1.7.1.min.js" type="text/javascript"></script>
	<script src=".panfolio/jquery.masonry.min.js" type="text/javascript"></script>

	<!-- default styling theme -->
	<link href=".panfolio/default.css" rel="stylesheet" type="text/css" />
</head>

<body>
<div id="gallery">
                  """

    html_append = """
<div id="content">
	<!-- also dynamic, just like the title tag -->
	<h1>&#9618; Gallery name goes here</h1>
	<p><a href="http://alfanumerico.net">http://alfanumerico.net</a></p>

	<!-- should be optional -->
	<div class="addthis_toolbox addthis_default_style addthis_32x32_style">
		<!-- which ones make in via command line flags, maybe? -->
		<a class="addthis_button_twitter"></a>
		<a class="addthis_button_facebook"></a>
		<a class="addthis_button_google_plusone_share"></a>
		<a class="addthis_button_tumblr"></a>
		<a class="addthis_button_instapaper"></a>
		<a class="addthis_button_email"></a>
	</div>
	<!-- delayed loading as it's not critical -->
	<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>
</div>
                   """

    html_footer = """
</div>

<script>
$( function() {
  var $container = $('#gallery');
  $container.imagesLoaded( function() {
    $container.masonry({
      columnWidth: function( containerWidth ) {
        return containerWidth / 5
      }
    });
  });	 
});
</script>

</body>
</html>
                  """

    html_gallery = []
    for filepath in glob.glob(allimages):
        type = mimetypes.guess_type(filepath)[0]
        filename = os.path.split(filepath)[1]
        thumbnail = '.panfolio/%s.jpg' % os.path.splitext(filename)[0]
        if type and 'image' in type:
            try:
                i = image.open(filepath)
                i.thumbnail(size, image.ANTIALIAS)
                i.save(args.dir + thumbnail, 'JPEG', quality=100, progressive=True)
            except IOError:
                print 'Thumbnailing failed for %s' % filepath
            item = "<div class='item'><a href='%s'><img class='thumbnail' src='%s' /></a></div>"  % (filename, thumbnail)
            html_gallery.append(item)
        else:
            print "Skipping file %s (it's not an image)" % filepath

    for res in resources:
        shutil.copy('resources/' + res, outpath)

    if args.fullscreen:
        html_data = html_header + '\n\t'.join(html_gallery) +  html_footer
    else:
        html_data = html_header + '\n\t'.join(html_gallery) + html_append +  html_footer

    with open (args.dir + 'index.html', 'w') as f:
        f.write(html_data)

if __name__ == '__main__':
    if not args.dir:
        parser.print_help()
        sys.exit(2)
    main()
    sys.exit(0)
